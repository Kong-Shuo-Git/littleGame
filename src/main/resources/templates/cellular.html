<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元胞复制机</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        game: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .cell-grid {
                display: grid;
                grid-template-columns: repeat(var(--grid-cols), minmax(0, 1fr));
                gap: 1px;
            }

            .cell-transition {
                transition: background-color 0.2s ease-in-out;
            }

            .btn-hover {
                @apply transition-all duration-300 hover:scale-105 active:scale-95;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-game text-dark">
<th:block th:replace="fragments/nav :: nav"></th:block>

<div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- 游戏标题 -->
    <header class="flex justify-between items-center mb-8">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent">
            元胞复制机
        </h1>
        <a href="/game/" class="bg-primary text-white px-6 py-3 rounded-lg transition-all duration-300 hover:bg-primary/90 hover:shadow-lg flex items-center gap-2">
            <i class="fa fa-home"></i>
            <span>返回首页</span>
        </a>
    </header>

    <!-- 游戏区域 -->
    <main class="flex flex-col lg:flex-row gap-8 items-center lg:items-start">
        <!-- 游戏控制面板 -->
        <div class="w-full lg:w-64 bg-white rounded-xl shadow-lg p-5 flex flex-col gap-4">
            <div class="space-y-3">
                <h2 class="text-xl font-semibold text-dark border-b pb-2">控制</h2>

                <!-- 控制按钮组 -->
                <div class="grid grid-cols-2 gap-3">
                    <button id="startBtn"
                            class="bg-secondary text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 btn-hover">
                        <i class="fa fa-play"></i>
                        <span>开始</span>
                    </button>
                    <button id="pauseBtn"
                            class="bg-amber-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 btn-hover hidden">
                        <i class="fa fa-pause"></i>
                        <span>暂停</span>
                    </button>
                    <button id="clearBtn"
                            class="bg-red-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 btn-hover">
                        <i class="fa fa-trash"></i>
                        <span>清除</span>
                    </button>
                    <button id="randomBtn"
                            class="bg-accent text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 btn-hover">
                        <i class="fa fa-random"></i>
                        <span>随机</span>
                    </button>
                </div>
            </div>

            <!-- 速度控制 -->
            <div class="space-y-3">
                <h3 class="font-medium text-gray-700">速度</h3>
                <input type="range" id="speedSlider" min="1" max="60" value="10"
                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                <div class="flex justify-between text-sm text-gray-500">
                    <span>慢</span>
                    <span>快</span>
                </div>
            </div>

            <!-- 网格大小控制 -->
            <div class="space-y-3">
                <h3 class="font-medium text-gray-700">网格大小</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button data-size="10" class="size-btn bg-gray-200 hover:bg-gray-300 py-1 rounded btn-hover">小
                    </button>
                    <button data-size="20" class="size-btn bg-primary text-white py-1 rounded btn-hover">中</button>
                    <button data-size="30" class="size-btn bg-gray-200 hover:bg-gray-300 py-1 rounded btn-hover">大
                    </button>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="space-y-2 pt-2 border-t">
                <h3 class="font-medium text-gray-700">统计</h3>
                <div class="bg-gray-50 rounded-lg p-3 text-sm">
                    <p><span class="text-gray-500">世代:</span> <span id="generationCount" class="font-medium">0</span>
                    </p>
                    <p><span class="text-gray-500">细胞数量:</span> <span id="cellCount" class="font-medium">0</span>
                    </p>
                </div>
            </div>

            <!-- 保存记录按钮 -->
            <div class="pt-4">
                <button id="saveRecordBtn"
                        class="w-full bg-primary text-white py-3 rounded-lg btn-hover flex items-center justify-center gap-2">
                    <i class="fa fa-save"></i>
                    <span>保存游戏记录</span>
                </button>
            </div>
        </div>

        <!-- 游戏网格区域 -->
        <div class="flex-1 flex flex-col items-center">
            <div id="gridContainer" class="bg-gray-200 rounded-lg p-2 shadow-md overflow-auto max-h-[70vh]">
                <div id="gameGrid" class="cell-grid bg-gray-300"></div>
            </div>

            <!-- 游戏规则说明 -->
            <div class="mt-6 bg-white rounded-xl shadow p-4 max-w-md">
                <h3 class="font-semibold text-lg mb-2">复制规则</h3>
                <ul class="text-sm text-gray-600 space-y-1 list-disc pl-5">
                    <li>活细胞周围有2-3个活邻居时，会保持存活</li>
                    <li>活细胞周围邻居少于2个或多于3个时，会死亡</li>
                    <li>死细胞周围有 exactly 3个活邻居时，会诞生新细胞</li>
                    <li>点击网格可以手动放置或移除细胞</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>元胞复制机 &copy; 2025 - 一个基于元胞自动机的小游戏</p>
    </footer>
</div>

<script>
    // 游戏状态变量
    let grid = [];
    let rows = 20;
    let cols = 20;
    let isRunning = false;
    let intervalId = null;
    let generation = 0;
    let speed = 10; // 每秒更新次数

    // DOM 元素
    const gameGrid = document.getElementById('gameGrid');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const clearBtn = document.getElementById('clearBtn');
    const randomBtn = document.getElementById('randomBtn');
    const speedSlider = document.getElementById('speedSlider');
    const generationCount = document.getElementById('generationCount');
    const cellCount = document.getElementById('cellCount');
    const sizeButtons = document.querySelectorAll('.size-btn');
    const saveRecordBtn = document.getElementById('saveRecordBtn');

    // 初始化网格
    function initializeGrid() {
        grid = [];
        for (let i = 0; i < rows; i++) {
            grid[i] = [];
            for (let j = 0; j < cols; j++) {
                grid[i][j] = 0; // 0 表示死细胞，1 表示活细胞
            }
        }
        renderGrid();
        updateStats();
    }

    // 渲染网格到DOM
    function renderGrid() {
        gameGrid.innerHTML = '';
        gameGrid.style.setProperty('--grid-cols', cols);

        // 计算单元格大小，确保在不同网格尺寸下有合适的显示
        const cellSize = Math.min(30, Math.floor(500 / cols));

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const cell = document.createElement('div');
                cell.className = `cell-transition rounded-sm ${grid[i][j] ? 'bg-primary' : 'bg-white'}`;
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;
                cell.dataset.row = i;
                cell.dataset.col = j;

                // 点击单元格切换状态
                cell.addEventListener('click', () => {
                    grid[i][j] = grid[i][j] ? 0 : 1;
                    renderGrid();
                    updateStats();
                });

                gameGrid.appendChild(cell);
            }
        }
    }
    // 继续游戏逻辑
    // 计算下一世代的网格状态
    function computeNextGeneration() {
        const nextGrid = [];

        for (let i = 0; i < rows; i++) {
            nextGrid[i] = [];
            for (let j = 0; j < cols; j++) {
                // 计算周围活细胞数量
                const neighbors = countNeighbors(i, j);

                // 应用规则
                if (grid[i][j] === 1) {
                    // 活细胞规则: 2-3个邻居存活，否则死亡
                    nextGrid[i][j] = (neighbors === 2 || neighbors === 3) ? 1 : 0;
                } else {
                    // 死细胞规则: 正好3个邻居则诞生
                    nextGrid[i][j] = (neighbors === 3) ? 1 : 0;
                }
            }
        }

        grid = nextGrid;
        generation++;
        renderGrid();
        updateStats();
    }

    // 计算指定细胞周围的活细胞数量
    function countNeighbors(row, col) {
        let count = 0;

        // 检查周围8个方向
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                // 跳过自身
                if (i === 0 && j === 0) continue;

                // 计算邻居坐标，处理边界（循环边界）
                const neighborRow = (row + i + rows) % rows;
                const neighborCol = (col + j + cols) % cols;

                count += grid[neighborRow][neighborCol];
            }
        }

        return count;
    }

    // 更新统计信息
    function updateStats() {
        generationCount.textContent = generation;

        // 计算活细胞总数
        let count = 0;
        for (let i = 0; i < rows; i++) {
            count += grid[i].reduce((a, b) => a + b, 0);
        }
        cellCount.textContent = count;
    }

    // 开始模拟
    function startSimulation() {
        if (!isRunning) {
            isRunning = true;
            startBtn.classList.add('hidden');
            pauseBtn.classList.remove('hidden');

            // 根据速度计算间隔时间（毫秒）
            const interval = 1000 / speed;
            intervalId = setInterval(computeNextGeneration, interval);
        }
    }

    // 暂停模拟
    function pauseSimulation() {
        if (isRunning) {
            isRunning = false;
            clearInterval(intervalId);
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
        }
    }

    // 清除网格
    function clearGrid() {
        pauseSimulation();
        generation = 0;
        initializeGrid();
    }

    // 随机生成细胞
    function randomizeGrid() {
        pauseSimulation();
        generation = 0;

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                grid[i][j] = Math.random() > 0.7 ? 1 : 0; // 30% 概率生成活细胞
            }
        }

        renderGrid();
        updateStats();
    }

    // 改变网格大小
    function changeGridSize(size) {
        pauseSimulation();
        rows = size;
        cols = size;
        generation = 0;

        // 更新按钮状态
        sizeButtons.forEach(btn => {
            if (parseInt(btn.dataset.size) === size) {
                btn.classList.add('bg-primary', 'text-white');
                btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            } else {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            }
        });

        initializeGrid();
    }

    // 保存游戏记录
    function saveGameRecord() {
        const score = parseInt(cellCount.textContent);
        const duration = 0; // 元胞自动机以细胞数量和世代数为主要指标
        const level = rows === 10 ? 'small' : rows === 20 ? 'medium' : 'large';
        
        // 构建请求数据
        const gameRecord = {
            gameType: 'cellular',
            score: score,
            level: level,
            duration: duration
        };
        
        // 发送请求到后端API
        fetch('/game/api/game/record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gameRecord)
        })
        .then(response => {
            return response.json().then(data => {
                // 即使状态码不是200，也解析响应体
                if (!response.ok) {
                    throw new Error(data.message || '保存失败');
                }
                return data;
            });
        })
        .then(data => {
            const sizeText = rows === 10 ? '小' : rows === 20 ? '中' : '大';
            alert(`游戏记录已成功保存到数据库！\n细胞数量: ${score}\n网格大小: ${sizeText}\n当前世代: ${generation}`);
        })
        .catch(error => {
            console.error('保存游戏记录失败:', error);
            alert(error.message || '保存游戏记录失败，请重试！');
        });
    }

    // 事件监听
    startBtn.addEventListener('click', startSimulation);
    pauseBtn.addEventListener('click', pauseSimulation);
    clearBtn.addEventListener('click', clearGrid);
    randomBtn.addEventListener('click', randomizeGrid);
    saveRecordBtn.addEventListener('click', saveGameRecord);

    speedSlider.addEventListener('input', (e) => {
        speed = parseInt(e.target.value);
        if (isRunning) {
            pauseSimulation();
            startSimulation();
        }
    });

    sizeButtons.forEach(button => {
        button.addEventListener('click', () => {
            changeGridSize(parseInt(button.dataset.size));
        });
    });

    // 窗口大小变化时重新渲染网格
    window.addEventListener('resize', renderGrid);

    // 初始化游戏
    initializeGrid();
</script>
</body>
</html>