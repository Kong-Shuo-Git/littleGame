<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扫雷游戏</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        game: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .mine-grid {
                display: grid;
                gap: 1px;
                background-color: #d1d5db;
                border: 3px outset #d1d5db;
            }

            .cell {
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                cursor: pointer;
                user-select: none;
                transition: all 0.1s;
            }

            .cell-closed {
                background-color: #9ca3af;
                border: 1px solid #6b7280;
            }

            .cell-opened {
                background-color: #e5e7eb;
                border: 1px solid #d1d5db;
            }

            .btn-hover {
                @apply transition-all duration-300 hover:scale-105 active:scale-95;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-game text-dark">
<th:block th:replace="fragments/nav :: nav"></th:block>
<div class="container mx-auto px-4 py-8">
    <!-- 游戏标题 -->
    <header class="flex justify-between items-center mb-8">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-danger to-warning">
            扫雷游戏
        </h1>
        <!-- 修复返回首页按钮链接 -->
        <a th:href="@{/index}"
           class="bg-primary text-white px-6 py-3 rounded-lg transition-all duration-300 hover:bg-primary/90 hover:shadow-lg flex items-center gap-2">
            <i class="fa fa-home"></i>
            <span>返回首页</span>
        </a>
    </header>

    <!-- 游戏区域 -->
    <main class="flex flex-col lg:flex-row gap-8 items-center lg:items-start">
        <!-- 游戏控制面板 -->
        <div class="w-full lg:w-64 bg-white rounded-xl shadow-lg p-5 flex flex-col gap-4">
            <div class="space-y-3">
                <h2 class="text-xl font-semibold text-dark border-b pb-2">控制</h2>

                <!-- 难度选择 -->
                <div class="space-y-2">
                    <h3 class="font-medium text-gray-700">难度</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="easyBtn" class="bg-green-500 text-white py-2 rounded-lg btn-hover">简单</button>
                        <button id="mediumBtn" class="bg-yellow-500 text-white py-2 rounded-lg btn-hover">中等</button>
                        <button id="hardBtn" class="bg-red-500 text-white py-2 rounded-lg btn-hover">困难</button>
                    </div>
                </div>

                <!-- 游戏控制按钮 -->
                <div class="grid grid-cols-1 gap-2">
                    <button id="restartBtn"
                            class="bg-secondary text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 btn-hover">
                        <i class="fa fa-refresh"></i>
                        <span>重新开始</span>
                    </button>
                </div>
            </div>

            <!-- 游戏状态 -->
            <div class="space-y-3">
                <h3 class="font-medium text-gray-700">游戏状态</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-100 rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-500">剩余地雷</p>
                        <p id="mineCount" class="text-xl font-bold text-danger">40</p>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-500">时间</p>
                        <p id="timer" class="text-xl font-bold text-primary">0</p>
                    </div>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="space-y-2 pt-2 border-t">
                <h3 class="font-medium text-gray-700">统计</h3>
                <div class="bg-gray-50 rounded-lg p-3 text-sm space-y-1">
                    <p><span class="text-gray-500">已翻开:</span> <span id="openedCount" class="font-medium">0</span>
                    </p>
                    <p><span class="text-gray-500">已标记:</span> <span id="flaggedCount" class="font-medium">0</span>
                    </p>
                </div>
            </div>

            <!-- 保存记录按钮 -->
            <div class="pt-4">
                <button id="saveRecordBtn"
                        class="w-full bg-primary text-white py-3 rounded-lg btn-hover flex items-center justify-center gap-2">
                    <i class="fa fa-save"></i>
                    <span>保存游戏记录</span>
                </button>
            </div>
        </div>

        <!-- 游戏区域 -->
        <div class="flex-1 flex flex-col items-center overflow-hidden">
            <div class="bg-white p-4 rounded-xl shadow-lg overflow-auto max-w-full">
                <div id="minefield" class="mine-grid p-2 mx-auto"></div>
            </div>

            <!-- 游戏说明 -->
            <div class="mt-6 bg-white rounded-xl shadow p-4 max-w-md">
                <h3 class="font-semibold text-lg mb-2">游戏规则</h3>
                <ul class="text-sm text-gray-600 space-y-1 list-disc pl-5">
                    <li>左键点击格子翻开</li>
                    <li>右键点击格子标记地雷</li>
                    <li>数字表示周围8个格子中的地雷数量</li>
                    <li>翻开所有非地雷格子获胜</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- 游戏结束弹窗 -->
    <div id="gameOverModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full text-center">
            <h2 id="gameOverTitle" class="text-2xl font-bold mb-3"></h2>
            <p id="gameOverMessage" class="mb-6 text-gray-600"></p>
            <button id="closeModalBtn" class="bg-primary text-white px-6 py-2 rounded-lg btn-hover">
                关闭
            </button>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>扫雷游戏 &copy; 2025</p>
    </footer>
</div>

<script th:inline="javascript">
    // 游戏状态变量
    let grid = [];
    let rows = 16;
    let cols = 16;
    let mineCount = 40;
    let flagsLeft = mineCount;
    let openedCells = 0;
    let flaggedCells = 0;
    let gameStarted = false;
    let gameOver = false;
    let timerInterval = null;
    let time = 0;

    // DOM 元素
    const minefield = document.getElementById('minefield');
    const mineCountElement = document.getElementById('mineCount');
    const timerElement = document.getElementById('timer');
    const openedCountElement = document.getElementById('openedCount');
    const flaggedCountElement = document.getElementById('flaggedCount');
    const restartBtn = document.getElementById('restartBtn');
    const easyBtn = document.getElementById('easyBtn');
    const mediumBtn = document.getElementById('mediumBtn');
    const hardBtn = document.getElementById('hardBtn');
    const saveRecordBtn = document.getElementById('saveRecordBtn');
    const gameOverModal = document.getElementById('gameOverModal');
    const gameOverTitle = document.getElementById('gameOverTitle');
    const gameOverMessage = document.getElementById('gameOverMessage');
    const closeModalBtn = document.getElementById('closeModalBtn');
    // 统一上下文路径，修复跳转404
    const BASE = /*[[@{/}]]*/ '';
    // 替换所有游戏卡片的点击事件
    document.querySelectorAll('.game-card').forEach(card => {
        card.addEventListener('click', function () {
            const gamePath = this.getAttribute('data-game-path');
            if (gamePath) {
                window.location.href = BASE + gamePath;
            }
        });
    });

    // 初始化游戏
    function initializeGame() {
        grid = [];
        flagsLeft = mineCount;
        openedCells = 0;
        flaggedCells = 0;
        gameStarted = false;
        gameOver = false;
        time = 0;

        // 停止计时器
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // 更新UI
        mineCountElement.textContent = flagsLeft;
        timerElement.textContent = time;
        openedCountElement.textContent = openedCells;
        flaggedCountElement.textContent = flaggedCells;

        // 计算单元格大小，确保棋盘能够适应屏幕
        const containerWidth = window.innerWidth - 400; // 减去侧边栏和边距
        const maxCellSize = cols > 16 ? Math.floor(containerWidth / cols) : 30; // 困难模式自动调整
        const cellSize = Math.max(20, Math.min(maxCellSize, 30)); // 限制最小和最大尺寸
        
        // 创建网格
        minefield.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
        minefield.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;
        minefield.innerHTML = '';

        // 初始化网格数据
        for (let i = 0; i < rows; i++) {
            grid[i] = [];
            for (let j = 0; j < cols; j++) {
                grid[i][j] = {
                    isMine: false,
                    isOpen: false,
                    isFlagged: false,
                    neighborMines: 0,
                    row: i,
                    col: j
                };

                // 创建单元格
                const cell = document.createElement('div');
                cell.className = 'cell cell-closed';
                cell.dataset.row = i;
                cell.dataset.col = j;
                cell.style.width = `${cellSize}px`;
                cell.style.height = `${cellSize}px`;

                // 添加点击事件
                cell.addEventListener('click', () => handleCellClick(i, j));
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    handleRightClick(i, j);
                });

                minefield.appendChild(cell);
            }
        }
    }

    // 设置难度
    function setDifficulty(difficulty) {
        switch (difficulty) {
            case 'easy':
                rows = 9;
                cols = 9;
                mineCount = 10;
                break;
            case 'medium':
                rows = 16;
                cols = 16;
                mineCount = 40;
                break;
            case 'hard':
                rows = 16;
                cols = 30;
                mineCount = 99;
                break;
        }
        initializeGame();
    }

    // 开始游戏并放置地雷
    function startGame(firstRow, firstCol) {
        gameStarted = true;

        // 放置地雷（避开第一次点击的位置及其周围）
        let minesPlaced = 0;
        while (minesPlaced < mineCount) {
            const row = Math.floor(Math.random() * rows);
            const col = Math.floor(Math.random() * cols);

            // 确保不会在第一次点击的位置或其周围放置地雷
            const distanceFromFirst = Math.abs(row - firstRow) + Math.abs(col - firstCol);
            if (!grid[row][col].isMine && distanceFromFirst > 1) {
                grid[row][col].isMine = true;
                minesPlaced++;
            }
        }

        // 计算每个单元格周围的地雷数量
        calculateNeighborMines();

        // 启动计时器
        timerInterval = setInterval(() => {
            time++;
            timerElement.textContent = time;
        }, 1000);
    }

    // 计算每个单元格周围的地雷数量
    function calculateNeighborMines() {
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                if (!grid[i][j].isMine) {
                    let count = 0;
                    for (let dx = -1; dx <= 1; dx++) {
                        for (let dy = -1; dy <= 1; dy++) {
                            const ni = i + dx;
                            const nj = j + dy;
                            if (ni >= 0 && ni < rows && nj >= 0 && nj < cols && grid[ni][nj].isMine) {
                                count++;
                            }
                        }
                    }
                    grid[i][j].neighborMines = count;
                }
            }
        }
    }

    // 处理单元格点击
    function handleCellClick(row, col) {
        const cell = grid[row][col];

        // 如果游戏已结束、单元格已翻开或已标记，不做任何操作
        if (gameOver || cell.isOpen || cell.isFlagged) {
            return;
        }

        // 第一次点击时开始游戏
        if (!gameStarted) {
            startGame(row, col);
        }

        // 翻开单元格
        openCell(row, col);

        // 检查游戏状态
        checkGameStatus();
    }

    // 处理右键点击
    function handleRightClick(row, col) {
        const cell = grid[row][col];

        // 如果游戏已结束或单元格已翻开，不做任何操作
        if (gameOver || cell.isOpen) {
            return;
        }

        // 第一次右键点击也开始游戏
        if (!gameStarted) {
            startGame(row, col);
        }

        // 切换标记状态
        if (cell.isFlagged) {
            // 取消标记
            cell.isFlagged = false;
            flagsLeft++;
            flaggedCells--;
        } else if (flagsLeft > 0) {
            // 添加标记
            cell.isFlagged = true;
            flagsLeft--;
            flaggedCells++;
        }

        // 更新UI
        updateCellDisplay(row, col);
        mineCountElement.textContent = flagsLeft;
        flaggedCountElement.textContent = flaggedCells;
    }

    // 翻开单元格
    function openCell(row, col) {
        const cell = grid[row][col];

        // 如果单元格已翻开或已标记，不做任何操作
        if (cell.isOpen || cell.isFlagged) {
            return;
        }

        // 翻开单元格
        cell.isOpen = true;
        openedCells++;
        updateCellDisplay(row, col);
        openedCountElement.textContent = openedCells;

        // 如果是地雷，游戏结束
        if (cell.isMine) {
            gameOver = true;
            clearInterval(timerInterval);
            revealMines();
            showGameOverMessage(false);
            return;
        }

        // 如果周围没有地雷，自动翻开周围的单元格
        if (cell.neighborMines === 0) {
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    const ni = row + dx;
                    const nj = col + dy;
                    if (ni >= 0 && ni < rows && nj >= 0 && nj < cols) {
                        openCell(ni, nj);
                    }
                }
            }
        }
    }

    // 更新单元格显示
    function updateCellDisplay(row, col) {
        const cell = grid[row][col];
        const cellElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);

        if (cell.isOpen) {
            cellElement.className = 'cell cell-opened';

            if (cell.isMine) {
                cellElement.innerHTML = '<i class="fa fa-bomb text-danger"></i>';
            } else if (cell.neighborMines > 0) {
                // 根据周围地雷数量设置不同颜色
                const colors = ['', 'text-blue-600', 'text-green-600', 'text-red-600',
                    'text-purple-600', 'text-yellow-600', 'text-cyan-600',
                    'text-pink-600', 'text-gray-600'];
                cellElement.textContent = cell.neighborMines;
                cellElement.classList.add(colors[cell.neighborMines]);
            }
        } else if (cell.isFlagged) {
            cellElement.innerHTML = '<i class="fa fa-flag text-danger"></i>';
        } else {
            cellElement.innerHTML = '';
        }
    }

    // 显示所有地雷
    function revealMines() {
        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                if (grid[i][j].isMine) {
                    grid[i][j].isOpen = true;
                    updateCellDisplay(i, j);
                }
            }
        }
    }

    // 检查游戏状态
    function checkGameStatus() {
        // 计算非地雷单元格数量
        const totalNonMines = rows * cols - mineCount;

        // 如果所有非地雷单元格都已翻开，游戏胜利
        if (openedCells === totalNonMines) {
            gameOver = true;
            clearInterval(timerInterval);

            // 自动标记所有地雷
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    if (grid[i][j].isMine && !grid[i][j].isFlagged) {
                        grid[i][j].isFlagged = true;
                        updateCellDisplay(i, j);
                    }
                }
            }

            showGameOverMessage(true);
        }
    }

    // 显示游戏结束消息
    function showGameOverMessage(isWin) {
        if (isWin) {
            gameOverTitle.textContent = '恭喜你！';
            gameOverMessage.textContent = `你成功完成了游戏！用时: ${time}秒`;
        } else {
            gameOverTitle.textContent = '游戏结束';
            gameOverMessage.textContent = '很遗憾，你踩到了地雷！';
        }
        gameOverModal.classList.remove('hidden');
        
        // 自动保存游戏记录到数据库
        saveGameRecord();
    }

    // 保存游戏记录
    function saveGameRecord() {
        // 确保游戏已结束才保存记录
        if (!gameOver) {
            alert('请完成游戏后再保存记录！');
            return;
        }
        
        const level = rows === 9 ? 'easy' : rows === 16 && cols === 16 ? 'medium' : 'hard';
        const score = openedCells === rows * cols - mineCount ? 1000 - time : 0;
        
        // 构建请求数据
        const gameRecord = {
            gameType: 'minesweeper',
            score: score,
            level: level,
            duration: time
        };
        
        // 发送请求到后端API
        fetch(BASE + 'api/game/record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gameRecord)
        })
        .then(response => {
            return response.json().then(data => {
                // 即使状态码不是200，也解析响应体
                if (!response.ok) {
                    throw new Error(data.message || '保存失败');
                }
                return data;
            });
        })
        .then(data => {
            alert(`游戏记录已成功保存到数据库！\n得分: ${score}\n难度: ${level}\n用时: ${time}秒`);
        })
        .catch(error => {
            console.error('保存游戏记录失败:', error);
            alert(error.message || '保存游戏记录失败，请重试！');
        });
    }

    // 窗口大小变化时重新渲染棋盘以适应屏幕
    window.addEventListener('resize', () => {
        if (!gameStarted) {
            initializeGame();
        }
    });
    
    // 事件监听
    restartBtn.addEventListener('click', initializeGame);
    easyBtn.addEventListener('click', () => setDifficulty('easy'));
    mediumBtn.addEventListener('click', () => setDifficulty('medium'));
    hardBtn.addEventListener('click', () => setDifficulty('hard'));
    saveRecordBtn.addEventListener('click', saveGameRecord);
    closeModalBtn.addEventListener('click', () => {
        gameOverModal.classList.add('hidden');
    });

    // 初始化游戏
    initializeGame();
</script>
</body>
</html>